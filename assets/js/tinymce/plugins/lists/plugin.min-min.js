tinymce.PluginManager.add("lists",function(e){function t(e){return e&&/^(OL|UL)$/.test(e.nodeName)}function n(e){return e.parentNode.firstChild==e}function r(e){return e.parentNode.lastChild==e}function i(t){return t&&!!e.schema.getTextBlockElements()[t.nodeName]}function s(e){return e&&"SPAN"===e.nodeName&&"bookmark"===e.getAttribute("data-mce-type")}var o=this;e.on("init",function(){function u(e){function t(t){var r,i,s;i=e[t?"startContainer":"endContainer"],s=e[t?"startOffset":"endOffset"],1==i.nodeType&&(r=S.create("span",{"data-mce-type":"bookmark"}),i.hasChildNodes()?(s=Math.min(s,i.childNodes.length-1),t?i.insertBefore(r,i.childNodes[s]):S.insertAfter(r,i.childNodes[s])):i.appendChild(r),i=r,s=0),n[t?"startContainer":"endContainer"]=i,n[t?"startOffset":"endOffset"]=s}var n={};return t(!0),e.collapsed||t(),n}function f(e){function t(t){function n(e){for(var t=e.parentNode.firstChild,n=0;t;){if(t==e)return n;(1!=t.nodeType||"bookmark"!=t.getAttribute("data-mce-type"))&&n++,t=t.nextSibling}return-1}var r,i,s;r=s=e[t?"startContainer":"endContainer"],i=e[t?"startOffset":"endOffset"],r&&(1==r.nodeType&&(i=n(r),r=r.parentNode,S.remove(s)),e[t?"startContainer":"endContainer"]=r,e[t?"startOffset":"endOffset"]=i)}t(!0),t();var n=S.createRng();n.setStart(e.startContainer,e.startOffset),e.endContainer&&n.setEnd(e.endContainer,e.endOffset),x.setRng(n)}function l(t,n){var r,i,s,o=S.createFragment(),u=e.schema.getBlockElements();if(e.settings.forced_root_block&&(n=n||e.settings.forced_root_block),n&&(i=S.create(n),i.tagName===e.settings.forced_root_block&&S.setAttribs(i,e.settings.forced_root_block_attrs),o.appendChild(i)),t)for(;r=t.firstChild;){var a=r.nodeName;s||"SPAN"==a&&"bookmark"==r.getAttribute("data-mce-type")||(s=!0),u[a]?(o.appendChild(r),i=null):n?(i||(i=S.create(n),o.appendChild(i)),i.appendChild(r)):o.appendChild(r)}return e.settings.forced_root_block?s||tinymce.Env.ie&&!(tinymce.Env.ie>10)||i.appendChild(S.create("br",{"data-mce-bogus":"1"})):o.appendChild(S.create("br")),o}function c(){return tinymce.grep(x.getSelectedBlocks(),function(e){return"LI"==e.nodeName})}function h(e,t,n){var r,i,s=S.select('span[data-mce-type="bookmark"]',e);n=n||l(t),r=S.createRng(),r.setStartAfter(t),r.setEndAfter(e),i=r.extractContents(),S.isEmpty(i)||S.insertAfter(i,e),S.insertAfter(n,e),S.isEmpty(t.parentNode)&&(tinymce.each(s,function(e){t.parentNode.parentNode.insertBefore(e,t.parentNode)}),S.remove(t.parentNode)),S.remove(t)}function p(e){var n,r;if(n=e.nextSibling,n&&t(n)&&n.nodeName==e.nodeName){for(;r=n.firstChild;)e.appendChild(r);S.remove(n)}if(n=e.previousSibling,n&&t(n)&&n.nodeName==e.nodeName){for(;r=n.firstChild;)e.insertBefore(r,e.firstChild);S.remove(n)}}function d(e){tinymce.each(tinymce.grep(S.select("ol,ul",e)),function(e){var n,r=e.parentNode;"LI"==r.nodeName&&r.firstChild==e&&(n=r.previousSibling,n&&"LI"==n.nodeName&&(n.appendChild(e),S.isEmpty(r)&&S.remove(r))),t(r)&&(n=r.previousSibling,n&&"LI"==n.nodeName&&n.appendChild(e))})}function v(e){function i(e){S.isEmpty(e)&&S.remove(e)}var s,o=e.parentNode,u=o.parentNode;return n(e)&&r(e)?("LI"==u.nodeName?(S.insertAfter(e,u),i(u),S.remove(o)):t(u)?S.remove(o,!0):(u.insertBefore(l(e),o),S.remove(o)),!0):n(e)?("LI"==u.nodeName?(S.insertAfter(e,u),e.appendChild(o),i(u)):t(u)?u.insertBefore(e,o):(u.insertBefore(l(e),o),S.remove(e)),!0):r(e)?("LI"==u.nodeName?S.insertAfter(e,u):t(u)?S.insertAfter(e,o):(S.insertAfter(l(e),o),S.remove(e)),!0):("LI"==u.nodeName?(o=u,s=l(e,"LI")):s=t(u)?l(e,"LI"):l(e),h(o,e,s),d(o.parentNode),!0)}function m(e){function n(n,r){var i;if(t(n)){for(;i=e.lastChild.firstChild;)r.appendChild(i);S.remove(n)}}var r,i;return r=e.previousSibling,r&&t(r)?(r.appendChild(e),!0):r&&"LI"==r.nodeName&&t(r.lastChild)?(r.lastChild.appendChild(e),n(e.lastChild,r.lastChild),!0):(r=e.nextSibling,r&&t(r)?(r.insertBefore(e,r.firstChild),!0):r&&"LI"==r.nodeName&&t(e.lastChild)?!1:(r=e.previousSibling,r&&"LI"==r.nodeName?(i=S.create(e.parentNode.nodeName),r.appendChild(i),i.appendChild(e),n(e.lastChild,i),!0):!1))}function g(){var t=c();if(t.length){for(var n=u(x.getRng(!0)),r=0;r<t.length&&(m(t[r])||0!==r);r++);return f(n),e.nodeChanged(),!0}}function y(){var t=c();if(t.length){var n,r,i=u(x.getRng(!0)),s=e.getBody();for(n=t.length;n--;)for(var o=t[n].parentNode;o&&o!=s;){for(r=t.length;r--;)if(t[r]===o){t.splice(n,1);break}o=o.parentNode}for(n=0;n<t.length&&(v(t[n])||0!==n);n++);return f(i),e.nodeChanged(),!0}}function b(n){function r(){function t(e){var t,n;for(t=o[e?"startContainer":"endContainer"],n=o[e?"startOffset":"endOffset"],1==t.nodeType&&(t=t.childNodes[Math.min(n,t.childNodes.length-1)]||t);t.parentNode!=u;){if(i(t))return t;if(/^(TD|TH)$/.test(t.parentNode.nodeName))return t;t=t.parentNode}return t}for(var n,r=[],u=e.getBody(),a=t(!0),f=t(),l=[],c=a;c&&(l.push(c),c!=f);c=c.nextSibling);return tinymce.each(l,function(e){if(i(e))return r.push(e),n=null,void 0;if(S.isBlock(e)||"BR"==e.nodeName)return"BR"==e.nodeName&&S.remove(e),n=null,void 0;var t=e.nextSibling;return s(e)&&(i(t)||!t&&e.parentNode==u)?(n=null,void 0):(n||(n=S.create("p"),e.parentNode.insertBefore(n,e),r.push(n)),n.appendChild(e),void 0)}),r}var o=x.getRng(!0),a=u(o),l=r();tinymce.each(l,function(e){var r,i;i=e.previousSibling,i&&t(i)&&i.nodeName==n?(r=i,e=S.rename(e,"LI"),i.appendChild(e)):(r=S.create(n),e.parentNode.insertBefore(r,e),r.appendChild(e),e=S.rename(e,"LI")),p(r)}),f(a)}function w(){var n=u(x.getRng(!0)),r=e.getBody();tinymce.each(c(),function(e){var n,i;if(S.isEmpty(e))return v(e),void 0;for(n=e;n&&n!=r;n=n.parentNode)t(n)&&(i=n);h(i,e)}),f(n)}function E(e){var t=S.getParent(x.getStart(),"OL,UL");if(t)if(t.nodeName==e)w(e);else{var n=u(x.getRng(!0));p(S.rename(t,e)),f(n)}else b(e)}var S=e.dom,x=e.selection;o.backspaceDelete=function(e){function n(e,t){var n=e.startContainer,r=e.startOffset;if(3==n.nodeType&&(t?r<n.data.length:r>0))return n;for(var i=new tinymce.dom.TreeWalker(e.startContainer);n=i[t?"next":"prev"]();)if(3==n.nodeType&&n.data.length>0)return n}function r(e,n){var r,i,s=e.parentNode;for(t(n.lastChild)&&(i=n.lastChild),r=n.lastChild,r&&"BR"==r.nodeName&&e.hasChildNodes()&&S.remove(r);r=e.firstChild;)n.appendChild(r);i&&n.appendChild(i),S.remove(e),S.isEmpty(s)&&S.remove(s)}if(x.isCollapsed()){var i=S.getParent(x.getStart(),"LI");if(i){var s=x.getRng(!0),o=S.getParent(n(s,e),"LI");if(o&&o!=i){var a=u(s);return e?r(o,i):r(i,o),f(a),!0}if(!o&&!e&&w(i.parentNode.nodeName))return!0}}},e.addCommand("Indent",function(){return g()?void 0:!0}),e.addCommand("Outdent",function(){return y()?void 0:!0}),e.addCommand("InsertUnorderedList",function(){E("UL")}),e.addCommand("InsertOrderedList",function(){E("OL")}),e.on("keydown",function(t){9==t.keyCode&&e.dom.getParent(e.selection.getStart(),"LI")&&(t.preventDefault(),t.shiftKey?y():g())})}),e.addButton("indent",{icon:"indent",title:"Increase indent",cmd:"Indent",onPostRender:function(){var t=this;e.on("nodechange",function(){var r=e.dom.getParent(e.selection.getNode(),"LI,UL,OL");t.disabled(r&&("LI"!=r.nodeName||n(r)))})}}),e.on("keydown",function(e){e.keyCode==tinymce.util.VK.BACKSPACE?o.backspaceDelete()&&e.preventDefault():e.keyCode==tinymce.util.VK.DELETE&&o.backspaceDelete(!0)&&e.preventDefault()})});